<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Visor Vertical TV 50"</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
        }

        #app-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #image-wrapper {
            transition: transform 0.1s ease-out;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        #image-wrapper:active { cursor: grabbing; }

        /* Estilos comunes para Imagen y Video */
        .media-content {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Full Frame */
            user-select: none;
            -webkit-user-drag: none;
            pointer-events: none;
            display: none; /* Oculto por defecto */
        }
        
        .media-content.active {
            display: block;
        }

        /* --- Feedback visual (Discreto en esquina inferior derecha) --- */
        .feedback-overlay {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.4);
            color: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 50%;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .show-feedback { opacity: 1; animation: fadeOut 2s forwards; }
        @keyframes fadeOut { 
            0% { opacity: 1; } 
            70% { opacity: 1; } 
            100% { opacity: 0; } 
        }

        /* UI */
        .info-ui { transition: opacity 0.5s; }
        
        /* Menú de Ajustes */
        #settings-menu {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(17, 24, 39, 0.98);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            width: 95%;
            max-width: 450px;
            height: 85vh;
            flex-direction: column;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        }

        /* --- Toggle Switch (Derecha) --- */
        .toggle-checkbox:checked {
            left: auto;
            right: 0;
            border-color: #fbbf24; 
            background-color: #fbbf24;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: rgba(251, 191, 36, 0.5); 
        }
        .toggle-checkbox {
            background-color: white; 
            border-color: #d1d5db;
        }

        /* --- Drag and Drop Styles --- */
        .playlist-item {
            cursor: grab;
            transition: background-color 0.2s, transform 0.2s;
        }
        .playlist-item:active { cursor: grabbing; }
        .playlist-item.dragging {
            opacity: 0.5;
            background-color: #374151;
            border: 1px dashed #fbbf24;
        }
        .playlist-item.drag-over {
            border-top: 2px solid #fbbf24;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-white font-sans antialiased">

    <div id="app-container">
        
        <div id="image-wrapper">
            <!-- Soportamos Imagen y Video -->
            <img id="main-image" class="media-content" src="" alt="Visor">
            <video id="main-video" class="media-content" loop muted playsinline autoplay></video>
        </div>

        <!-- UI: Contador Oculto -->
        <div id="counter-container" class="hidden info-ui absolute top-4 right-4 bg-gray-900/60 backdrop-blur-md px-4 py-2 rounded-full text-lg font-bold z-40 border border-white/20 flex items-center gap-2">
            <i id="play-icon" data-lucide="play" class="w-4 h-4 text-green-400 hidden"></i>
            <span id="counter">1 / 1</span>
        </div>

        <div id="intro-msg" class="absolute bottom-10 bg-gray-900/80 backdrop-blur-md px-6 py-4 rounded-xl text-center border border-white/10 z-40 max-w-sm">
            <h2 class="text-xl font-bold mb-2 text-yellow-400">Controles</h2>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-300 text-left">
                <div class="flex items-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Anterior</div>
                <div class="flex items-center gap-2"><i data-lucide="arrow-right" class="w-4 h-4"></i> Siguiente</div>
                <div class="flex items-center gap-2"><i data-lucide="arrow-up" class="w-4 h-4"></i> Zoom +</div>
                <div class="flex items-center gap-2"><i data-lucide="arrow-down" class="w-4 h-4"></i> Zoom -</div>
                <div class="col-span-2 text-xs text-gray-400 mt-1">
                    * Con Zoom usa <strong>W A S D</strong> para moverte
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-500 border-t border-gray-700 pt-1">
                Presiona <strong>'C'</strong> para Configurar
            </div>
        </div>

        <!-- Feedback Visual Discreto -->
        <div id="feedback" class="feedback-overlay">
            <i id="feedback-icon" width="24" height="24"></i>
        </div>

        <!-- MENÚ DE AJUSTES -->
        <div id="settings-menu" style="display: none;">
            <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-gray-900 rounded-t-xl">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <img src="https://i.imgur.com/BhsVE7z.png" alt="Trotter Logo" class="h-8 w-auto object-contain">
                    Ajustes
                </h3>
                <button onclick="toggleMenu()" class="text-gray-400 hover:text-white bg-gray-800 p-2 rounded-full transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 space-y-6 no-scrollbar">
                
                <!-- Añadir Contenido -->
                <section>
                    <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Añadir Contenido (9:16)</h4>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button onclick="document.getElementById('file-input').click()" class="bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white py-3 px-2 rounded-lg transition flex flex-col items-center justify-center gap-1 h-24">
                            <i data-lucide="file-plus" class="w-6 h-6 text-blue-400"></i>
                            <span class="text-xs font-medium text-center mt-1">Subir Fotos<br>o Videos</span>
                        </button>
                        <input type="file" id="file-input" accept="image/*,video/*" multiple class="hidden">

                        <button onclick="document.getElementById('url-input-container').classList.toggle('hidden')" class="bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white py-3 px-2 rounded-lg transition flex flex-col items-center justify-center gap-1 h-24">
                            <i data-lucide="link" class="w-6 h-6 text-green-400"></i>
                            <span class="text-xs font-medium text-center mt-1">Añadir por URL</span>
                        </button>
                    </div>

                    <div id="url-input-container" class="hidden flex gap-2 mb-2">
                        <input type="text" id="new-image-url" placeholder="https://..." class="flex-1 p-2 bg-gray-900 border border-gray-600 rounded text-sm">
                        <button onclick="addNewContentFromUrl()" class="bg-green-600 px-3 rounded text-white"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <p id="menu-msg" class="text-xs text-center font-semibold text-green-400 h-4"></p>
                </section>

                <!-- Lista de Reproducción -->
                <section>
                    <div class="flex justify-between items-end mb-3">
                        <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Lista de Reproducción</h4>
                        <span id="playlist-count" class="text-xs text-gray-500">1 item</span>
                    </div>
                    <p class="text-[10px] text-gray-500 mb-2 italic">Arrastra los items para reordenar</p>
                    
                    <div id="playlist-items" class="space-y-2">
                        <!-- Items -->
                    </div>
                </section>

                <!-- Slideshow -->
                <section class="border-t border-gray-700 pt-5">
                    <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Automorización</h4>
                    <div class="bg-gray-800 p-3 rounded-lg flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="relative inline-block w-10 align-middle select-none">
                                <input type="checkbox" id="slideshow-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full border-4 appearance-none cursor-pointer transition-all duration-300 left-0"/>
                                <label for="slideshow-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-600 cursor-pointer"></label>
                            </div>
                            <span class="text-sm">Auto-play</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="slideshow-interval" value="5" min="1" class="w-12 bg-gray-900 border border-gray-600 rounded p-1 text-center text-sm">
                            <span class="text-xs text-gray-500">seg</span>
                        </div>
                    </div>
                </section>

                <!-- Memoria Local -->
                <section class="border-t border-gray-700 pt-5 mt-5">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">Autoguardado Activo</span>
                        <div class="flex gap-3">
                            <button onclick="clearLocalStorage()" class="text-xs text-red-400 hover:text-red-300 underline">
                                Restaurar Valores de Fábrica
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </div>

    </div>

    <script>
        // --- ESTADO INICIAL ---
        const DEFAULT_PLAYLIST = [
            { type: 'image', url: "https://i.imgur.com/53hnmuT.png" },
            { type: 'image', url: "https://i.imgur.com/JiKag5B.png" },
            { type: 'image', url: "https://i.imgur.com/y98nb3A.png" },
            { type: 'image', url: "https://i.imgur.com/g9m0HAt.png" },
            { type: 'image', url: "https://i.imgur.com/Y6uBhgg.png" },
            { type: 'image', url: "https://i.imgur.com/m8tht3j.png" },
            { type: 'image', url: "https://i.imgur.com/sSAsypt.png" },
            { type: 'image', url: "https://i.imgur.com/2W0KvSv.png" },
            { type: 'image', url: "https://i.imgur.com/WPRc4Cc.png" },
            { type: 'image', url: "https://i.imgur.com/5hmqn9L.png" }
        ];

        // --- SISTEMA DE PERSISTENCIA (CARGA) ---
        // 1. Cargar Playlist
        let savedPlaylist = localStorage.getItem('tv_playlist');
        let playlist = savedPlaylist ? JSON.parse(savedPlaylist) : [...DEFAULT_PLAYLIST];
        if (!Array.isArray(playlist) || playlist.length === 0) {
            playlist = [...DEFAULT_PLAYLIST];
        }

        // 2. Cargar Configuración (Slideshow)
        let savedSlideshowEnabled = localStorage.getItem('tv_slideshow_enabled');
        let savedSlideshowInterval = localStorage.getItem('tv_slideshow_interval');

        let slideshowEnabled = savedSlideshowEnabled === 'true'; // Por defecto false si es null
        let slideshowIntervalTime = savedSlideshowInterval ? parseInt(savedSlideshowInterval) : 5000;
        
        let currentIndex = 0;
        let scale = 1;
        let pointX = 0;
        let pointY = 0;
        let isDraggingImage = false;
        let startX = 0;
        let startY = 0;
        let slideshowTimer = null;

        const MIN_SCALE = 1;
        const MAX_SCALE = 5;
        const ZOOM_STEP = 0.2;
        const PAN_STEP = 50; 

        // Referencias DOM
        const imgElement = document.getElementById('main-image');
        const videoElement = document.getElementById('main-video');
        const wrapper = document.getElementById('image-wrapper');
        const counterElement = document.getElementById('counter');
        const feedbackEl = document.getElementById('feedback');
        const feedbackIcon = document.getElementById('feedback-icon');
        const introMsg = document.getElementById('intro-msg');
        const menuEl = document.getElementById('settings-menu');
        const urlInput = document.getElementById('new-image-url');
        const menuMsg = document.getElementById('menu-msg');
        const fileInput = document.getElementById('file-input');
        const playlistContainer = document.getElementById('playlist-items');
        const playlistCountLabel = document.getElementById('playlist-count');
        
        // Elementos de Configuración
        const slideshowToggle = document.getElementById('slideshow-toggle');
        const intervalInput = document.getElementById('slideshow-interval');

        lucide.createIcons();

        // Inicializar Inputs de Configuración con valores guardados
        slideshowToggle.checked = slideshowEnabled;
        intervalInput.value = slideshowIntervalTime / 1000;

        // --- SISTEMA DE PERSISTENCIA (GUARDADO AUTOMÁTICO) ---

        function saveState() {
            // 1. Guardar Playlist (Solo URLs válidas, no blobs locales)
            const persistableItems = playlist.filter(item => {
                return item.url && !item.url.startsWith('blob:');
            });
            if (persistableItems.length > 0) {
                localStorage.setItem('tv_playlist', JSON.stringify(persistableItems));
            }
            
            // 2. Guardar Configuración
            localStorage.setItem('tv_slideshow_enabled', slideshowEnabled);
            localStorage.setItem('tv_slideshow_interval', slideshowIntervalTime);
        }

        function clearLocalStorage() {
            if(confirm("¿Restaurar configuración de fábrica? Esto borrará tus cambios.")) {
                localStorage.removeItem('tv_playlist');
                localStorage.removeItem('tv_slideshow_enabled');
                localStorage.removeItem('tv_slideshow_interval');
                location.reload(); // Recargar para aplicar cambios limpios
            }
        }

        // --- GESTIÓN DE CONTENIDO ---

        function getMediaType(url, fileType) {
            if (fileType) {
                return fileType.startsWith('video/') ? 'video' : 'image';
            }
            const ext = url.split('.').pop().toLowerCase().split('?')[0];
            if (['mp4', 'webm', 'ogg', 'mov'].includes(ext)) return 'video';
            return 'image';
        }

        function updateMainDisplay() {
            if (playlist.length === 0) playlist = [...DEFAULT_PLAYLIST];
            if (currentIndex >= playlist.length) currentIndex = 0;

            const item = playlist[currentIndex];
            
            imgElement.style.opacity = '0.5';
            videoElement.style.opacity = '0.5';

            setTimeout(() => {
                if (item.type === 'video') {
                    imgElement.classList.remove('active');
                    videoElement.classList.add('active');
                    videoElement.src = item.url;
                    videoElement.play().catch(e => console.log("Autoplay bloqueado:", e));
                } else {
                    videoElement.pause();
                    videoElement.classList.remove('active');
                    imgElement.classList.add('active');
                    imgElement.src = item.url;
                    imgElement.style.objectFit = 'cover';
                }

                updateCounter();
                resetZoom();
                
                imgElement.style.opacity = '1';
                videoElement.style.opacity = '1';
                
                if(menuEl.style.display === 'flex') renderPlaylist();
            }, 100);
        }

        function updateCounter() {
            counterElement.innerText = `${currentIndex + 1} / ${playlist.length}`;
        }

        // --- DRAG AND DROP PLAYLIST ---

        let draggedItemIndex = null;

        function renderPlaylist() {
            playlistContainer.innerHTML = '';
            
            playlist.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = 'playlist-item flex items-center gap-3 bg-gray-800/50 p-2 rounded-lg border border-gray-700/50 relative';
                row.draggable = true;
                row.dataset.index = index;
                
                if(index === currentIndex) {
                    row.classList.add('bg-gray-700', 'border-yellow-500/50');
                }

                const isLocalFile = item.url.startsWith('blob:');
                const warningIcon = isLocalFile ? `<i data-lucide="alert-circle" class="w-3 h-3 text-yellow-500 ml-1" title="Archivo local: No se guardará al cerrar"></i>` : '';

                row.innerHTML = `
                    <div class="cursor-grab p-1 text-gray-600 hover:text-white">
                        <i data-lucide="grip-vertical" class="w-4 h-4"></i>
                    </div>
                    <div class="h-10 w-8 bg-gray-900 rounded overflow-hidden flex-shrink-0 flex items-center justify-center border border-gray-700">
                        ${item.type === 'image' 
                            ? `<img src="${item.url}" class="w-full h-full object-cover opacity-80">`
                            : `<i data-lucide="film" class="w-4 h-4 text-blue-400"></i>`
                        }
                    </div>
                    <div class="flex-1 min-w-0">
                        <span class="text-xs text-gray-300 block truncate font-mono flex items-center">
                            Item ${index + 1} ${warningIcon}
                        </span>
                        <span class="text-[10px] uppercase text-gray-500 font-bold tracking-wider">${item.type}</span>
                    </div>
                    
                    <button onclick="deleteItem(${index})" class="p-2 hover:text-red-400">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;

                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
                
                playlistContainer.appendChild(row);
            });
            
            playlistCountLabel.innerText = `${playlist.length} item${playlist.length !== 1 ? 's' : ''}`;
            lucide.createIcons();
        }

        function handleDragStart(e) {
            draggedItemIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragEnter(e) { e.preventDefault(); }
        function handleDragOver(e) { e.preventDefault(); this.classList.add('drag-over'); return false; }
        function handleDragLeave(e) { this.classList.remove('drag-over'); }
        function handleDrop(e) {
            e.stopPropagation();
            const targetIndex = parseInt(this.dataset.index);
            if (draggedItemIndex !== targetIndex) {
                const itemToMove = playlist[draggedItemIndex];
                playlist.splice(draggedItemIndex, 1);
                playlist.splice(targetIndex, 0, itemToMove);

                if (currentIndex === draggedItemIndex) currentIndex = targetIndex;
                else if (currentIndex > draggedItemIndex && currentIndex <= targetIndex) currentIndex--;
                else if (currentIndex < draggedItemIndex && currentIndex >= targetIndex) currentIndex++;

                saveState(); // AUTOGUARDADO
                renderPlaylist();
                updateMainDisplay();
            }
            return false;
        }
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.playlist-item').forEach(item => item.classList.remove('drag-over'));
        }

        function deleteItem(index) {
            if (playlist.length <= 1) {
                showMenuMessage("Mínimo 1 item requerido", "error");
                return;
            }
            playlist.splice(index, 1);
            if (index < currentIndex) currentIndex--;
            else if (index === currentIndex) {
                if (currentIndex >= playlist.length) currentIndex = playlist.length - 1;
                updateMainDisplay();
            }
            saveState(); // AUTOGUARDADO
            renderPlaylist();
            updateCounter();
        }

        // --- CARGA DE ARCHIVOS ---

        fileInput.addEventListener('change', function(event) {
            const files = event.target.files;
            if (files && files.length > 0) {
                let count = 0;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const objectUrl = URL.createObjectURL(file);
                    const type = getMediaType(file.name, file.type);
                    
                    // Nota: Blobs no se pueden guardar en localStorage
                    playlist.push({ type: type, url: objectUrl, isLogo: false });
                    count++;
                }
                showMenuMessage(`${count} añadidos (Temp)`, 'success');
                // No guardamos blobs
                renderPlaylist();
                updateCounter();
                fileInput.value = '';
            }
        });

        function addNewContentFromUrl() {
            const url = urlInput.value.trim();
            if (url) {
                const type = getMediaType(url, null);
                playlist.push({ type: type, url: url, isLogo: false });
                urlInput.value = '';
                saveState(); // AUTOGUARDADO
                renderPlaylist();
                updateCounter();
                showMenuMessage(`URL guardada`, "success");
            }
        }

        // --- ZOOM & PAN ---

        function resetZoom() {
            scale = 1; pointX = 0; pointY = 0;
            updateTransform();
        }

        function updateTransform() {
            wrapper.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
            wrapper.style.cursor = scale > 1 ? 'grab' : 'default';
            if (isDraggingImage) wrapper.style.cursor = 'grabbing';
        }

        function zoomIn() {
            scale = Math.min(scale + ZOOM_STEP, MAX_SCALE);
            updateTransform(); showFeedback('zoom-in');
        }

        function zoomOut() {
            scale -= ZOOM_STEP;
            if (scale <= MIN_SCALE) { scale = MIN_SCALE; pointX = 0; pointY = 0; }
            updateTransform(); showFeedback('zoom-out');
        }

        // --- SLIDESHOW ---

        slideshowToggle.addEventListener('change', () => {
            slideshowEnabled = slideshowToggle.checked;
            saveState(); // AUTOGUARDADO
            if (slideshowEnabled) {
                startSlideshow();
                document.getElementById('play-icon').classList.remove('hidden');
            } else {
                stopSlideshow();
                document.getElementById('play-icon').classList.add('hidden');
            }
        });

        intervalInput.addEventListener('change', () => {
             slideshowIntervalTime = (parseInt(intervalInput.value) || 5) * 1000;
             saveState(); // AUTOGUARDADO
             if (slideshowEnabled) startSlideshow();
        });

        function startSlideshow() {
            stopSlideshow();
            const ms = slideshowIntervalTime;
            slideshowTimer = setInterval(() => {
                if (menuEl.style.display === 'none' && !isDraggingImage) nextItem(true);
            }, ms);
        }

        function stopSlideshow() {
            if (slideshowTimer) clearInterval(slideshowTimer);
        }

        function resetTimer() {
            if (slideshowEnabled) startSlideshow();
        }

        // --- NAVEGACIÓN ---

        function nextItem(isAuto = false) {
            if (playlist.length <= 1 && !isAuto) return; 
            currentIndex = (currentIndex < playlist.length - 1) ? currentIndex + 1 : 0;
            updateMainDisplay();
            if (!isAuto) { showFeedback('arrow-right'); resetTimer(); }
        }

        function prevItem() {
            if (playlist.length <= 1) return;
            currentIndex = (currentIndex > 0) ? currentIndex - 1 : playlist.length - 1;
            updateMainDisplay();
            showFeedback('arrow-left');
            resetTimer();
        }

        function showFeedback(iconName) {
            feedbackIcon.setAttribute('data-lucide', iconName);
            lucide.createIcons();
            feedbackEl.classList.remove('show-feedback');
            void feedbackEl.offsetWidth; 
            feedbackEl.classList.add('show-feedback');
            if(introMsg.style.opacity !== '0') {
                introMsg.style.opacity = '0';
                setTimeout(() => introMsg.style.display = 'none', 500);
            }
        }

        // --- EVENTOS ---

        function toggleMenu() {
            const isHidden = menuEl.style.display === 'none';
            if (isHidden) {
                menuEl.style.display = 'flex';
                renderPlaylist();
            } else {
                menuEl.style.display = 'none';
                menuMsg.textContent = '';
                document.body.focus();
            }
        }

        function showMenuMessage(text, type) {
            menuMsg.textContent = text;
            menuMsg.className = type === 'success' ? "text-xs text-center font-semibold text-green-400 h-4" : "text-xs text-center font-semibold text-red-400 h-4";
            setTimeout(() => menuMsg.textContent = '', 2000);
        }

        document.addEventListener('keydown', (e) => {
            const isMenuOpen = menuEl.style.display !== 'none';
            const key = e.key.toLowerCase();

            // Tecla 'C' para Configurar
            if (key === 'c') {
                if (isMenuOpen && document.activeElement.tagName === 'INPUT') return;
                e.preventDefault(); toggleMenu(); return;
            }

            if (isMenuOpen) { 
                if (e.key === 'Escape') toggleMenu(); 
                return; 
            }
            
            switch(key) {
                // Navegación Normal
                case 'arrowleft':  prevItem(); break;
                case 'arrowright': nextItem(); break;
                case 'arrowup':    zoomIn(); e.preventDefault(); break;
                case 'arrowdown':  zoomOut(); e.preventDefault(); break;
                
                // Panning con WASD (Solo con Zoom)
                case 'w': if(scale > 1) { pointY += PAN_STEP; updateTransform(); } break;
                case 's': if(scale > 1) { pointY -= PAN_STEP; updateTransform(); } break;
                case 'a': if(scale > 1) { pointX += PAN_STEP; updateTransform(); } break;
                case 'd': if(scale > 1) { pointX -= PAN_STEP; updateTransform(); } break;
            }
        });

        window.addEventListener('wheel', (e) => {
            if(menuEl.style.display !== 'none') return;
            e.deltaY < 0 ? zoomIn() : zoomOut();
        });

        wrapper.addEventListener('mousedown', (e) => {
            if (scale > 1) { isDraggingImage = true; startX = e.clientX - pointX; startY = e.clientY - pointY; wrapper.style.cursor = 'grabbing'; }
        });
        window.addEventListener('mousemove', (e) => {
            if (!isDraggingImage) return;
            e.preventDefault(); pointX = e.clientX - startX; pointY = e.clientY - startY; updateTransform();
        });
        window.addEventListener('mouseup', () => { isDraggingImage = false; if (scale > 1) wrapper.style.cursor = 'grab'; resetTimer(); });

        // Iniciar estado
        updateMainDisplay();
        if (slideshowEnabled) startSlideshow();
        if (slideshowEnabled) document.getElementById('play-icon').classList.remove('hidden');

    </script>
</body>
</html>
